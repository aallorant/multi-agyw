---
title: Mathematical appendix to "Spatio-temporal estimates of HIV risk group proportions for adolescent
  girls and young women across 13 priority countries in sub-Saharan Africa"
subtitle: |
  Corresponding author: Adam Howes (`ath19@ic.ac.uk`)
output:
  pdf_document:
    toc: true
    number_sections: true
    keep_tex: true
    includes:
      in_header: preamble.tex
bibliography: citations.bib
---

\newpage

<!-- So that the tables and figures in this appendix are prefixed by "A." -->
\setcounter{table}{0}  
\renewcommand{\thetable}{A.\arabic{table}} 
\setcounter{figure}{0} 
\renewcommand{\thefigure}{A.\arabic{figure}}

# Modelling of risk group proportions {#modelling-of-risk-group-proportions}

## Overview

Let $i \in \{1, \ldots, n\}$ denote subnational units (Table B.5) which partition the 13 studied AGYW priority countries $c[i] \in \{1, \ldots, 13\}$.
We considered the years 1999-2018 denoted as $t \in \{1, \ldots, T\}$ and age groups $a \in \{\text{15--19}, \text{20--24}, \text{25--29}\}$.
Let the four risk groups be $k \in \{1, 2, 3, 4\}$ and denote being in either the third or fourth risk group by $k = 3^{+}$.

First, we used a multinomial logistic regression model to infer the proportion of AGYW in the risk groups $k \in \{1, 2, 3^{+}\}$.
This model can be specified using a multinomial likelihood
\begin{equation}
    \y_{ita} = (y_{ita1}, \ldots, y_{ita3^{+}})^\top \sim \text{Multinomial}(m_{ita}; \, p_{ita1}, \ldots, p_{ita3^{+}}),
\end{equation}
where the number of women in risk group $k$ is $y_{itak}$, the sample size is $m_{ita} = \sum_{k = 1}^{3^{+}} y_{itak}$, and $p_{itak} > 0$ is the probability of membership of the $k$th risk group with $\sum_{k = 1}^{3^{+}} p_{itak} = 1$.
Taking $k = 1$ to be the baseline category, linear predictors may be specified for the additive log ratios $\log(p_{itak} / p_{ita1})$.
Rather than taking this approach directly, to facilitate inference in the `R-INLA`, we used an equivalent Poisson log-linear model via the multinomial-Poisson transformation [@baker1994multinomial].
This transformation, and further details about this model, are presented in Section 1.2.

Next, we fit a logistic regression model to estimate the proportion of those in the $k = 3^{+}$ risk group that were in the $k = 3$ and $k = 4$ risk groups respectively.
This model was of the form
\begin{align}
    y_{ia4} &\sim \text{Binomial} \left( y_{ia3} + y_{ia4}, q_{ia} \right), \label{eq:logistic-regression} \\
    q_{ia} &= \text{logit}^{-1} \left( \eta_{ia} \right), 
\end{align}
where $q_{ia} = p_{ia4} / (p_{ia3} + p_{ia4}) = p_{ia4} / p_{ia{3^+}}$ and the linear predictor $\eta_{ia}$ is chosen suitably, described in more detail in Section 1.3.
Taking this two-step approach allowed us to include all surveys in the multinomial regression model, but only those surveys with a specific transactional sex question in Equation \ref{eq:logistic-regression}.
As all such surveys occurred in 2013-2018, in the logistic regression model $q_{ia}$ was assumed to be constant over time.

To facilitate uncertainty quantification, we took 1000 posterior samples (indexed by $s$) from each of the multinomial $\{p_{itak}^s\}$ and logistic regression $\{q_{ia}^s\}$ models.
Samples $p_{ita3}^s$ and $p_{ita4}^s$ were then generated by splitting samples from the $k = 3^{+}$ category of the multinomial model via $p_{ita3}^s = (1 - q_{ia}^s)p_{ita{3^+}^s}$ and $p_{ita4}^s = q_{ia}^s p_{ita{3^+}}^s$.

As transactional sex does not directly correspond to sex work [@wamoyi2016transactional], we adjusted our samples so that at a national level, the population size estimates match FSW population size estimates at a national level by age.
Our methodology for producing these estimates is described in Section \ref{fsw-population-size-estimation}.
In making this adjustment, we assumed that subnational variation in the FSW proportions corresponds to that of the transactional sex proportions.

We calculated the mean, median, 2.5\% and 97.5\% quantiles for the risk group probabilities empirically using the adjusted samples.
To produce aggregated estimates, such as the age category 15-24 or any national estimates, we weighted the adjusted samples by population sizes $N_{ita} = \sum_k N_{itak}$ obtained from the Naomi model [@eaton2021naomi].

## Multinomial regression model

### The multinomial-Poisson transformation

The multinomial-Poisson transformation reframes a given multinomial logisitic regression model as an equivalent Poisson log-linear model of the form
\begin{align}
    y_{itak} &\sim \text{Poisson}(\kappa_{itak}), \label{eq:poisson} \\
    \log(\kappa_{itak}) &= \eta_{itak},
\end{align}
for certain choice of the linear predictor $\eta_{itak}$.
The basis of the transformation is that, conditional on their sum, Poisson counts are jointly multinomially distributed [@mccullagh1989generalized] as follows
\begin{equation}
    \mathbf{y}_{ita} \, | \, m_{ita} \sim \text{Multinomial} \left( m_{ita}; \frac{\kappa_{ita1}}{\kappa_{ita}}, \ldots, \frac{\kappa_{ita3^{+}}}{\kappa_{ita}} \right),
\end{equation}
where $\kappa_{ita} = \sum_{k = 1}^{3^{+}} \kappa_{itak}$ such that category probabilites are obtained by the softmax funciton
\begin{equation}
    p_{itak} = \frac{\exp(\eta_{itak})}{\sum_{k = 1}^{3^{+}} \exp(\eta_{itak})} = \frac{\kappa_{itak}}{\sum_{k = 1}^{3^{+}} \kappa_{itak}} = \frac{\kappa_{itak}}{\kappa_{ita}}.
\end{equation}
In the equivalent model, the sample sizes $m_{ita} = \sum_k y_{itak}$ are treated as random, rather than fixed as they would be in the multinomial logistic regression model, taking a Poisson distribution
\begin{equation}
    m_{ita} \sim \text{Poisson} \left( \kappa_{ita} \right).
\end{equation}
In the equivalent model, the joint distribution of $p(\mathbf{y}_{ita}, m_{ita}) = p(\mathbf{y}_{ita} \, | \, m_{ita})p(m_{ita})$ is
\begin{align}
p(\mathbf{y}_{ita}, m_{ita}) &= \exp(-\kappa_{ita}) \frac{(\kappa_{ita})^{m_{ita}}}{m_{ita}!} \times \frac{m_{ita}!}{\prod_k y_{itak}!} \prod_k \left( \frac{\kappa_{itak}}{\kappa_{ita}} \right)^{y_{itak}} \\
&= \prod_k \left( \frac{\exp(-\kappa_{itak}) \left( \kappa_{itak} \right)^{y_{itak}}}{y_{itak}!} \right) \\
&= \prod_k \text{Poisson} \left( y_{itak} \, | \, \kappa_{itak} \right). \label{eq:prodpoisson}
\end{align}
corresponding to the product of independent Poisson likelihoods as in Equation \ref{eq:poisson}.
This model, including random sample sizes, is equivalent to the multinomial logistic regression only when these normalisation constants are recovered exactly.
To ensure that this is the case, one approach is to include observation-specific random effects $\theta_{ita}$ in the equation for the linear predictor.
Multiplying each of $\{\kappa_{itak}\}_{k = 1}^{3^+}$ by $\exp(\theta_{ita})$ has no effect on the category probabilities, but does provide the necessary flexibility for $\kappa_{ita}$ to recover $m_{ita}$ exactly.
Although in theory an improper prior $\theta_{ita} \propto 1$ should be used, in practise, by keeping $\eta_{ita}$ otherwise small using appropriate constraints, so that arbitrarily large values of $\theta_{ita}$ are not required, it is sufficient (and practically preferable for inference) to instead use a vague prior.

### Model specifications

\begin{table}[htb]
\small
\centering
\begin{tabularx}{\textwidth}{lllllll}
\midrule
Model ID & Category ($\beta_k$) & Country ($\zeta_{ck}$) & Age ($\alpha_{ack}$) & Spatial ($\phi_{ik}$) & Temporal ($\gamma_{tk}$) & Spatio-temporal ($\delta{itk}$) \\
\midrule
M1 & IID & IID & IID & IID & IID & Not included \\
M2 & IID & IID & IID & Besag & IID & Not included \\
M3 & IID & IID & IID & IID & AR1 & Not included \\
M4 & IID & IID & IID & Besag & AR1 & Not included \\
\midrule
\end{tabularx}
\caption{The multinomial regression models that we considered. Observation random effects $\theta_{ita}$ are omitted from this table.}
\label{tab:multinomial-models}
\small
\end{table}

<!-- To add once they work: -->
<!-- M1x & IID & IID & IID & IID & IID & IID $\otimes$ IID \\ -->
<!-- M2x & IID & IID & IID & Besag & IID  & Besag $\otimes$ IID \\ -->
<!-- M3x & IID & IID & IID & IID & AR1 & IID $\otimes$ AR1 \\ -->
<!-- M4x & IID & IID & IID & Besag & AR1 & Besag $\otimes$ AR1 \\ -->

We considered four models (Table \ref{tab:multinomial-models}) for $\eta_{ita}$ of the form
$$
\eta_{ita} = \theta_{ita} + \beta_k + \zeta_{c[i]k} + \alpha_{ac[i]k} + \phi_{ik} + \gamma_{tk}.
$$
<!-- + \delta_{itk} -->
As described above, we included observation random effects $\theta_{ita} \sim \mathcal{N}(0, 1000^2)$ in all models we considered.
To capture country-specific proportion estimates for each category, we included category random effects $\beta_k \sim \mathcal{N}(0, \tau_\beta^{-1})$ and country-category random effects $\zeta_{ck} \sim \mathcal{N}(0, \tau_\zeta^{-1})$.
Heterogeneity in risk group proportions by age was allowed by including age-country-category random effects $\alpha_{ack} \sim \mathcal{N}(0, \tau_\alpha^{-1})$.
We considered two specifications, independent and identically distributed (IID) and Besag [@besag1991bayesian], for the space-category $\phi_{ik}$ random effects (Section \ref{sec:spatial-random-effects}) and two specifications, IID and first order autoregressive (AR1), for the year-category $\gamma_{tk}$ random effects (Section \ref{sec:temporal-random-effects}).
<!-- We also considered separable space-year-category interactions $\delta_{itk}$ with corresponding Kronecker product structure (Section \ref{sec:spatio-temporal-random-effects}). -->
All random effect precision parameters $\tau \in \{\tau_\beta, \tau_\zeta, \tau_\alpha, \tau_\phi, \tau_\gamma\}$ were given independent penalised complexity (PC) priors [@simpson2017penalising] with base model $\sigma = 0$ given by $p(\tau) = 0.5 \nu \tau^{-3/2} \exp \left( - \nu \tau^{-1/2} \right)$ where $\nu = - \ln(0.01) / 2.5$ such that  $\mathbb{P}(\sigma > 2.5) = 0.01$.
<!-- \tau_\delta -->

### Spatial random effects \label{sec:spatial-random-effects}

The specifications we considered were IID
$$
\phi_{ik} \sim \mathcal{N}(0, \tau_\phi^{-1}),
$$
and Besag grouped by category
$$
\bphi = (\phi_{11}, \ldots, \phi_{n1}, \ldots, \phi_{13^{+}}, \ldots \phi_{n3^{+}})^\top \sim \mathcal{N}(\mathbf{0}, (\tau_\phi \mathbf{R}^\star_\phi)^{-}),
$$
where the scaled structure matrix $\mathbf{R}^\star_\phi = \mathbf{R}^\star_b \otimes \mathbf{I}$ is given by the Kronecker product of the scaled Besag structure matrix $\mathbf{R}^\star_b$ and the identity matrix $\mathbf{I}$, and ${-}$ denotes the generalised matrix inverse.
Scaling of the structure matrix to have generalised variance one ensures interpretable priors may be placed on the precision parameter [@sorbye2014scaling].
We followed the further recommendations of @freni2018note with regard to disconnected adjacency graphs, singletons and constraints.
The Besag structure matrix $\mathbf{R}_b$ is obtained by the precision matrix of the random effects $\mathbf{b} = (b_1, \ldots, b_n)^\top$ with full conditionals
\begin{equation}
b_i \, | \, \mathbf{b}_{-i} \sim \N\left(\frac{\sum_{j: j \sim i} b_j}{n_{\delta i}}, \frac{1}{n_{\delta i}}\right),
\end{equation}
where $j \sim i$ if the districts $A_i$ and $A_j$ are adjacent, and $n_{\delta i}$ is the number of districts adjacent to $A_i$.

In preliminary testing, we excluded spatial random effects from the model, but found that this negatively effected performance.
We also tested using the BYM2 model [@simpson2017penalising] in place of the Besag, but found that the proportion parameter posteriors tended to be highly peaked at the value one.
For simplicity and to avoid numerical issues, by using Besag random effects we decided to fix this proportion to one.

### Temporal random effects \label{sec:temporal-random-effects}

The specifications we considered were IID
$$
\phi_{tk} \sim \mathcal{N}(0, \tau_\phi^{-1}),
$$
and AR1 grouped by category
$$
\bm{\gamma} = (\gamma_{11}, \ldots, \gamma_{13^{+}}, \ldots, \gamma_{T1}, \ldots, \gamma_{T3^{+}})^\top \sim \mathcal{N}(\mathbf{0}, (\tau_\phi \mathbf{R}^\star_\gamma)^{-}),
$$
where the scaled structure matrix $\mathbf{R}^\star_\gamma = \mathbf{R}^\star_r \otimes \mathbf{I}$ is given by the Kronecker product of a scaled AR1 structure matrix $\mathbf{R}^\star_r$ and the identity matrix $\mathbf{I}$.
The AR1 structure matrix $\mathbf{R}_r$ is obtained by precision matrix of the random effects $\mathbf{r} = (r_1, \ldots, r_T)^\top$ specified by
\begin{align}
r_1 &\sim \left( 0, \frac{1}{1 - \rho^2} \right), \\
r_t &= \rho r_{t - 1} + \epsilon_t, \quad t = 2, \ldots, T, 
\end{align}
where $\epsilon_t \sim \mathcal{N}(0, 1)$ and $|\rho| < 1$.
For the lag-one correlation parameter $\rho$, we used the PC prior, as derived by @sorbye2017penalised, with base model $\rho = 1$ and condition $\mathbb{P}(\rho > 0 = 0.75)$.
We chose the base model $\rho = 1$ corresponding to no change in behaviour over time, rather than the alternative $\rho = 0$ corresponding to no correlation in behaviour over time, as we judged the former to be more plausible a priori.

<!-- ### Spatio-temporal random effects \label{sec:spatio-temporal-random-effects} -->

<!-- We used the specification -->
<!-- \begin{equation} -->
<!--     \bm{\delta} = (\delta_{111}, \ldots, \delta_{nT3^{+}})^\top \sim \mathcal{N}(\mathbf{0}, (\tau_\delta \mathbf{R}^\star_\delta)^{-}), -->
<!-- \end{equation} -->
<!-- where $\mathbf{R}^\star_\delta$ is a Kronecker product of the relevant space, time and category structure matrices. -->
<!-- In particular, for each of the four models including spatio-temporal interactions, these matrices are -->

<!-- 1. No spatial or temporal structure (Type I) $\mathbf{R}^\star_\delta = \mathbf{I} \otimes \mathbf{I} \otimes \mathbf{I}$, -->
<!-- 2. Structured spatial and unstructured temporal (Type II) $\mathbf{R}^\star_\delta = \mathbf{R}^\star_b \otimes \mathbf{I} \otimes \mathbf{I}$, -->
<!-- 3. Unstructured spatial and structured temporal (Type III) $\mathbf{R}^\star_\delta = \mathbf{I} \otimes \mathbf{R}^\star_a \otimes \mathbf{I}$, -->
<!-- 4. Structured spatial and temporal (Type IV) $\mathbf{R}^\star_\delta = \mathbf{R}^\star_b \otimes \mathbf{R}^\star_a \otimes \mathbf{I}$, -->

<!-- where the first, second and third elements of the Kronecker product represent space, time and category strucutre matrices respectively. -->
<!-- The interaction type in brackets (e.g. Type I) is given according to the @knorr2000bayesian framework. -->

### Constraints

To ensure interpretable posterior inferences of random effect contribution, we applied sum-to-zero constraints such that none of the category interaction random effects altered overall category probabilities.
For the space-year-category random effects, we applied analogous sum-to-zero constraints to maintain roles of the space-category and year-category random effects.
Together, these were:

1. Category $\sum_k \beta_k = 0$
2. Country $\sum_c \zeta_{ck} = 0, \, \forall \, k$
3. Age-country $\sum_a \alpha_{ack} = 0, \, \forall \, c, k$,
4. Spatial $\sum_i \phi_{ik} = 0, \, \forall \, k$
5. Temporal $\sum_t \gamma_{tk} = 0, \, \forall \, k$
<!-- 6. Spatio-temporal\footnote{It was not possible to fully implement these constraints in \texttt{R-INLA}. This only effects the variance components interpretation.} $\sum_i \delta_{itk} = 0, \, \forall \, t, k; -->
<!-- \quad \sum_t \delta_{itk} = 0, \, \forall \, i, k; -->
<!-- \quad \sum_k \delta_{itk} = 0, \, \forall \, i, t$ -->

### Survey weighted likelihood

<!-- To account for the complex survey design, in which individuals have unequal sampling probabilities, we replaced the observed counts $\{y_{itak}\}$ in each risk group with weighted counts $\{y_{itak}^\star\}$ and used a pseudo-likelihood to extend the Poisson distribution to non-integer weighted counts. -->

The surveys we included use a complex design, in which each individual has an unequal probability of being included in the sample.
The DHS [@measure2012sampling], for example, often employs a two-stage cluster design, first taking an urban rural stratified sample of ennumeration areas, before selecting households from each ennumeration area using systematic sampling.

To account for this aspect of survey design, we use a weighted pseudo-likelihood where the observed counts $y$ are replaced by effective counts $y^\star$ calculated using the survey weights $w_j$ of all individuals $j$ in the corresponding strata.
We multiplied direct estimates produced using the `survey` package [@JSSv009i08] by the Kish effective sample size [@kish1965survey]
\begin{equation}
    m^\star = \frac{\left(\sum_j w_j \right)^2}{\sum_j {w_j}^2}
\end{equation}
to obtain $y^\star$.
These counts may not be integers, and as such the Poisson likelihood we used in Equation \ref{eq:poisson} is not appropriate.
Instead, we used a generalised Poisson pseudo-likelihood $y^\star \sim \text{xPoisson}(\kappa)$, given by
\begin{equation}
    p(y^\star) = \frac{\kappa^{y^\star}}{\left \lfloor{y^\star!}\right \rfloor } \exp \left(- \kappa \right),
\end{equation}
as implemented by `family = "xPoisson"` in `R-INLA`, which accepts non-integer input.

### Model selection

We performed model selection on the basis of the conditional predictive ordinate (CPO) criterion [@pettit1990conditional], selecting model M2.
This model included Besag spatial random effects and IID temporal random effects.
The deviance information criterion (DIC) [@spiegelhalter2002bayesian] and widely applicable information criterion (WAIC) [@watanabe2013widely] are included for reference (Table \ref{tab:multinomial-model-performance} and Figure \ref{fig:multinomial-model-performance}).

\begin{table}[h]
\centering
\begin{tabularx}{0.65\textwidth}{lllll}
\toprule
 & M1 & M2 & M3 & M4 \\ 
\midrule
DIC & 100780 (300) & 101588 (317) & 100781 (300) & 101589 (317) \\ 
WAIC & 103763 (358) & 105008 (383) & 103763 (358) & 105009 (383) \\ 
CPO & 5573 (36) & 5772 (36) & 5574 (36) & 5771 (36) \\ 
\bottomrule
\end{tabularx}
\caption{Multinomial regression model performance. For the CPO, higher values indicate better model performance. For the DIC and WAIC, lower values indicate better model performance.}
\label{tab:multinomial-model-performance}
\end{table}

\begin{figure}[h]
    \centering
    \makebox[\textwidth][c]{\includegraphics{depends/model-comparison.png}}
    \caption{Multinomial regression model performance, with the best performing model(s) according to each criterion shown as a square. For the CPO, higher values indicate better model performance for the CPO. For the DIC and WAIC, lower values indicate better model performance.}
    \label{fig:multinomial-model-performance}
\end{figure}

## Logistic regression model

\begin{table}[htb]
\small
\centering
\begin{tabularx}{\textwidth}{llllll}
\midrule
Model ID & Intercept ($\beta_0$) & Age ($\alpha_a$) & Country ($\zeta_{c}$) & Spatial ($\phi_i$) & Covariates \\ 
\midrule
L1 & Constant & IID & IID & IID & Not included \\
L2 & Constant & IID & IID & Besag & Not included \\
L3 & Constant & IID & IID & IID & \texttt{cfswever} \\
L4 & Constant & IID & IID & Besag & \texttt{cfswever} \\
L5 & Constant & IID & IID & IID & \texttt{cfswrecent} \\
L6 & Constant & IID & IID & Besag & \texttt{cfswrecent} \\
\midrule
\end{tabularx}
\caption{The logistic regression models that were considered. \texttt{cfswever} denotes the proportion of men who have ever paid for sex and \texttt{cfswrecent} denotes the proportion of men who have paid for sex in the past 12 months.}
\label{tab:logistic-models}
\small
\end{table}

We considered six logistic regression models (Table \ref{tab:logistic-models}) each including a constant $\beta_0 \sim \mathcal{N}(-2, 1^2)$, age random effects $\alpha_a \sim \mathcal{N}(0, \tau_\alpha^{-1})$ and country random effects $\zeta_{c} \sim \mathcal{N}(0, \tau_\zeta^{-1})$.
The prior on $\beta_0$ placed 95\% prior probability on the range `r 100 * round(plogis(-4), 2)`-`r 100 * round(plogis(0), 2)`\% for the percentage of those with non-regular or multiple partners who report transactional sex.
We considered two specifications (IID, Besag) for the spatial random effects $\phi_i$.
To aid estimation with sparse data, we also considered national-level covariates for the proportion of men who have paid for sex ever \texttt{cfswever} or in the last twelve months \texttt{cfswrecent}, available from @hodgins2022population.
For both random effect precision parameters $\tau \in \{\tau_\alpha, \tau_\zeta\}$ we used the PC prior with base model $\sigma = 0$ and $\mathbb{P}(\sigma > 2.5 = 0.01)$.
For the regression parameters $\beta \in \{\beta_\texttt{cfswever}, \beta_\texttt{cfswrecent}\}$ we used the prior $\beta \sim \mathcal{N}(0, 2.5^2)$.

### Survey weighted likelihood

As with the multinomial regression model, we used survey weighted counts $\{y_{itak}^\star\}$ and sample sizes $\{m_{itak}^\star\}$.
We used a generalised binomial pseudo-likelihood $y^\star \sim \text{xBinomial}(m^\star, q)$, as implemented by \texttt{family = "xBinomial"} in \texttt{R-INLA}, given by
\begin{equation}
    p(y^\star \, | \, m^\star, q) =  \binom{\lfloor m^\star \rfloor}{\lfloor y^\star \rfloor} q^{y^\star} (1 - q)^{m^\star - y^\star}.
\end{equation}
to extend the binomial distribution to non-integer weighted counts and sample sizes.

### Model selection

We selected the best model according to the CPO statistic, which was model L6.
CPO values, along with DIC and WAIC values for reference, are presented in Table \ref{tab:logistic-model-performance} and Figure \ref{fig:logistic-model-performance}.
Inclusion of Besag spatial random effects, rather than IID, consistently improved performance.
Benefits from inclusion of covariates were more marginal.
That said, as some countries had no suitable surveys, we preferred to include covariate information such that the estimates in these countries are based on some country-specific data.

\begin{table}[h]
\centering
\begin{tabularx}{0.82\textwidth}{lllllll}
\toprule
 & L1 & L2 & L3 & L4 & L5 & L6 \\ 
\midrule
DIC & 4662 (110) & 4605 (111) & 4662 (110) & 4605 (111) & 4662 (110) & 4605 (111) \\ 
WAIC & 4692 (115) & 4624 (115) & 4692 (115) & 4624 (115) & 4692 (115) & 4624 (115) \\ 
CPO & 950 (15) & 969 (15) & 951 (15) & 970 (15) & 950 (15) & 970 (15) \\ 
\bottomrule
\end{tabularx}
\caption{Logistic regression model performance. For the CPO, higher values indicate better model performance. For the DIC and WAIC, lower values indicate better model performance.}
\label{tab:logistic-model-performance}
\end{table}

\begin{figure}[h]
    \centering
    \makebox[\textwidth][c]{\includegraphics{depends/fsw-logit-model-comparison.png}}
    \caption{Logistic regression model performance, with the best performing model(s) according to each criterion shown as a square.}
    \label{fig:logistic-model-performance}
\end{figure}

## Coverage assessment

To assess the calibration of our fitted model, we calculated the quantile $q$ of each observation within the posterior predictive distribution.
For calibrated models, these quantiles, known as probability integral transform (PIT) values [@dawid1984present; @bosse2022scoringutils], should follow a uniform distribution $q \sim \mathcal{U}[0, 1]$.
To generate samples from the posterior predictive distribution, we applied the multinomial likelihood to samples from the latent field, setting the sample size to be the floor of the Kish effective sample size.

Using the PIT values, it is possible to calculate the empirical coverage of all $(1 - \alpha)100$\% (equal-tailed) posterior predictive credible intervals.
These empirical coverages can be compared to the nominal coverage $(1 - \alpha)$ for each value of $\alpha \in [0, 1]$ to give empirical cumulative distribution function (ECDF) difference values.
This approach has the advantage of considering all possible confidence values at once.
@sailynoja2021graphical develop binomial distribution-based simultaneous confidence bands for ECDF difference values which test uniformity.

Figure \ref{fig:coverage} shows the PIT histogram and ECDF difference plots for our final model, faceted by risk group.
<!-- Comment on the results. -->
<!-- What is going on with the cohabiting partner group towards one? -->

\begin{figure}
  \centering
  \makebox[\textwidth][c]{\includegraphics{depends/coverage.png}}
  \caption{Probability integral transform (PIT) histograms (top row) and empirical cumulative distribution function (ECDF) difference plots (bottom row) for the final selected model.}
  \label{fig:coverage}
\end{figure}

\clearpage

# FSW population size estimation {#fsw-population-size-estimation}

To estimate the number of FSW by age group and country, we disaggregated country-specific estimates of adult (15-49) FSW population size from @stevens2022estimating by age group.

First, we calculated the total sexually debuted population in each age group, in each country.
To describe the distribution of age at first sex, we used skew logistic distributions [@nguyen2022trends] with cumulative distribution function given by
\begin{equation}
F(x) = \left(1 + \exp(\kappa_c (\mu_c - x)) \right)^{- \gamma_c},
\end{equation}
where $\kappa_c, \mu_c, \gamma_c > 0$ are country-specific shape, shape and skewness parameters respectively.

Next, we used the assumed $\text{Gamma}(\alpha = 10.4, \beta = 0.36)$ FSW age distribution in South Africa from the Thembisa model [@johnson2020thembisa] to calculate the implied ratio between the number of FSW and the sexually debuted population in each age group.
We assumed that those ratios in South Africa were applicable to every country, and thereby calculated the number of FSW by age group in all 13 countries (Figure \ref{fig:age-disagg-fsw-line}).

\begin{figure}
  \centering
  \makebox[\textwidth][c]{\includegraphics{depends/age-disagg-fsw-line.png}}
  \caption{Proportion of FSW by age group (including the age groups 30-34, 35-39, 40-44 and 45-49) as produced by our disaggregation procedure.}
  \label{fig:age-disagg-fsw-line}
\end{figure}

\clearpage

# Prevalence, incidence and expected new infections reached {#hiv-indicators}

## Calculation of prevalence and PLHIV

We calculated HIV prevalence $\rho_{iak}$ and number of people living with HIV (PLHIV) $H_{iak}$ stratified according to district, age group and risk group by disaggregating Naomi estimates by risk group.

To do so, we estimated HIV prevalence log odds ratios relative to the general population using age, country and risk group specific HIV prevalence bio-marker survey data.
We also included general population HIV prevalence data, allowing us to fit a logistic regression model including indicator functions for each risk group, and an indicator for being in the general population.
The regression coefficients in this model correspond to log odds, such that log odds ratios may be easily obtained by taking the difference.

To allow the log odds ratio for the highest risk group to vary based on general population prevalence we fit a linear regression of the FSW log odds against the general population log odds.
<!-- TODO: Include the data source that was used for this. -->
We ensured that the log odds ratio for the highest risk group was at least as large as that of the second highest risk group.

Given the fitted log odds ratios $\log(\text{OR}_k)$, we disaggregated Naomi estimates of PLHIV $H_{ia}$ on the logit scale using numerically optimisation to obtain the value of $\theta$ minimising the function
\begin{equation}
\hat \theta = \argmin_{\theta \in [-10, 10]} \left( \sum_{k} \left( \text{logistic}(\theta + \log(\text{OR}_k)) \cdot N_{iak} \right) - H_{ia} \right)^2
\end{equation}
where $\text{logistic}(x) = \exp(x) / (1 + \exp(x))$ such that $\text{logistic}(\hat \theta + \log(\text{OR}_k)) = \rho_{iak}$.
Figures B.18 - B.30 show the resulting HIV prevalence estimates by risk group in each country.
The number of PLHIV are then obtained by $H_{iak} = \rho_{iak} N_{iak}$, where $N_{iak}$ is the risk group population size.

## Calculation of incidence and expected number of new infections

We calculated HIV incidence $\lambda_{iak}$ and number of new HIV infections $I_{iak}$ stratified according to district, age group and risk group by linear disaggregation
\begin{align}
    I_{ia} &= \sum_k I_{iak} = \sum_k \lambda_{iak}N_{iak} \\
    &= 0 + \lambda_{ia2} N_{ia2} + \lambda_{ia3} N_{ia3} + \lambda_{ia4} N_{ia4} \\
    &= \lambda_{ia2} \left(N_{ia2}  + \text{RR}_{3} N_{ia3} + \text{RR}_4(\lambda_{ia}) N_{ia4}  \right).
\end{align}
Risk group specific HIV incidence estimates are then given by
\begin{align}
    \lambda_{ia1} &= 0, \\
    \lambda_{ia2} &= I_{ia} / \left(N_{ia2} + \text{RR}_{3} N_{ia3} + \text{RR}_4(\lambda_{ia}) N_{ia4}\right), \\
    \lambda_{ia3} &= \text{RR}_{3} \lambda_{ia2}, \\
    \lambda_{ia4} &= \text{RR}_4(\lambda_{ia}) \lambda_{ia2}.
\end{align}
which we evaluated using Naomi model estimates of the number of new HIV infections $I_{ia} = \lambda_{ia} N_{ia}$, HIV infection risk ratios $\{\text{RR}_3, \text{RR}_4(\lambda_{ia})\}$, and risk group population sizes as above.
The risk ratio $\text{RR}_4(\lambda_{ia})$ was defined as a function of general population incidence.
Figures B.31 - B.43 show the resulting HIV incidence estimates by risk group in each country.
The number of new HIV infections are then $I_{iak} = \lambda_{iak} N_{iak}$.

## Calculation of expected new infections reached

We calculated the number of new infections that would be reached prioritising according to each possible stratification of the population--that is for all $2^3 = 8$ possible combinations of stratification by location, age, and risk group. 
As an illustration, for stratification just by age, we aggregated the number of new HIV infections and HIV incidence as such 
\begin{align}
    I_a &= \sum_{ik} I_{iak}, \\
    \lambda_a &= I_a / \sum_{ik} N_{iak}.
\end{align}
Under this stratification, individuals in each age group $a$ are prioritised according to the highest HIV incidence $\lambda_a$.
By cumulatively summing the expected infections, for each fraction of the total population reached we calculated the fraction of total expected new infections that would be reached.
Figures B.44 - B.56 show the percentage of new infections that would be reached prioritising according to each possible stratification within each country.

This analysis was relatively simple.
More involved analyses might consider prioritisation of a hypothetical intervention which has some, possibly varying, probability of preventing HIV acquisition, as well as the costs associated to its roll-out.

\newpage

# References {#references .unnumbered}
